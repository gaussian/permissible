{% extends "admin/base_site.html" %}

{% block extrahead %}{{ block.super }}
{{ form.media }}
<style>
    .role-cell {
        cursor: pointer;
        transition: background-color 0.2s;
        border-left: 1px solid #eee;
        border-right: 1px solid #eee;
        border-collapse: collapse;
        text-align: center;
    }
    .role-cell:hover {
        background-color: #f5f5f5;
    }
</style>
{% endblock %}

{% load custom_tags %}

{% block content %}
<div id="content-main">
    {% if form.errors %}
        <p class="errornote">Please correct the error(s) below.</p>
        {{ form.non_field_errors }}
    {% endif %}

    <form method="post" id="{{ opts.model_name }}_form" novalidate>
        {% csrf_token %}
        {{ form.role_changes }}

        <table style="margin-bottom: 30px">
            <tr style="background-color: #eee">
                <th rowspan="2">PermRoot Objects</th>
                <th colspan="{{ first_roles.keys|length|default:0 }}" style="text-align: center">Roles</th>
                <th rowspan="2">User's permissions on this object</th>
            </tr>
            <tr style="background-color: #eee">
                {% for role in first_roles.keys %}
                    <th>{{ role }}</th>
                {% endfor %}
            </tr>

            {% for root, data in root_to_roles.items %}
                <tr>
                    <td>{{ root }}</td>
                    {% for role, role_users in data.roles.items %}
                        <td class="role-cell"
                            data-root-id="{{ root.pk }}" 
                            data-role="{{ role }}">
                            <span class="checkmark">
                            {% if user.pk|stringformat:"s" in role_users %}
                                ‚úîÔ∏è
                            {% endif %}
                            </span>
                        </td>
                    {% endfor %}
                    <td>
                        {{ data.perms|join:", " }}
                    </td>
                </tr>
            {% endfor %}
        </table>

        <input type="submit" value="Save Changes" name="_submit">
    </form>
</div>

<script>
const roleChanges = {
    added: {},
    removed: {}
};

function updateRoleChanges() {
    const jsonStr = JSON.stringify(roleChanges);
    document.getElementById('id_role_changes').value = jsonStr;
}

document.querySelectorAll('.role-cell').forEach(cell => {
    cell.addEventListener('click', function() {
        const rootId = this.dataset.rootId;
        const role = this.dataset.role;
        const checkmark = this.querySelector('.checkmark');
        const hasCheck = checkmark.textContent.includes('‚úîÔ∏è');
        const wasAdded = checkmark.textContent.includes('üîµ');
        const wasRemoved = checkmark.textContent.includes('‚ùå');
        
        if (!roleChanges.added[rootId]) roleChanges.added[rootId] = {};
        if (!roleChanges.removed[rootId]) roleChanges.removed[rootId] = {};
        
        if (hasCheck) {
            checkmark.textContent = '‚ùå';
            roleChanges.removed[rootId][role] = true;
        } else if (wasRemoved) {
            checkmark.textContent = '‚úîÔ∏è';
            delete roleChanges.removed[rootId][role];
        } else if (wasAdded) {
            checkmark.textContent = '';
            delete roleChanges.added[rootId][role];
        } else {
            checkmark.textContent = 'üîµ';
            roleChanges.added[rootId][role] = true;
        }
        
        if (Object.keys(roleChanges.added[rootId] || {}).length === 0) {
            delete roleChanges.added[rootId];
        }
        if (Object.keys(roleChanges.removed[rootId] || {}).length === 0) {
            delete roleChanges.removed[rootId];
        }
        
        updateRoleChanges();
    });
});
</script>
{% endblock %}
